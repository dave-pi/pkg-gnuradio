From bb7b61a4629ce2dea274c413c61ecb330c8c2297 Mon Sep 17 00:00:00 2001
From: Sebastian Koslowski <sebastian.koslowski@gmail.com>
Date: Wed, 4 Apr 2018 23:27:28 +0200
Subject: [PATCH 1/7] grc: fix grid_pos eval

---
 grc/core/Param.py | 22 +++++++++++++---------
 1 file changed, 13 insertions(+), 9 deletions(-)

diff --git a/grc/core/Param.py b/grc/core/Param.py
index 01697919d0..31465c7edb 100644
--- a/grc/core/Param.py
+++ b/grc/core/Param.py
@@ -541,6 +541,7 @@ class Param(Element):
         # Grid Position Type
         #########################
         elif t == 'grid_pos':
+            self.hostage_cells.clear()
             if not v:
                 # Allow for empty grid pos
                 return ''
@@ -560,15 +561,18 @@ class Param(Element):
             except:
                 my_parent = ''
             # Calculate hostage cells
-            for r in range(row_span):
-                for c in range(col_span):
-                    self.hostage_cells.append((my_parent, (row + r, col + c)))
-            # Avoid collisions
-            params = filter(lambda p: p is not self, self.get_all_params('grid_pos'))
-            for param in params:
-                for parent, cell in param._hostage_cells:
-                    if (parent, cell) in self.hostage_cells:
-                        raise Exception('Another graphical element is using parent "{0}", cell "{1}".'.format(str(parent), str(cell)))
+            for r in range(row, row + row_span):
+                for c in range(col, col + col_span):
+                    self.hostage_cells.add((my_parent, (r, c)))
+
+            for other in self.get_all_params('grid_pos'):
+                if other is self:
+                    continue
+                collision = next(iter(self.hostage_cells & other.hostage_cells), None)
+                if collision:
+                    raise Exception('Block {block!r} is also using parent {parent!r}, cell {cell!r}.'.format(
+                        block=other.get_parent().get_id(), parent=collision[0] or 'main', cell=collision[1]
+                    ))
             return e
         #########################
         # Notebook Page Type
-- 
2.11.0

