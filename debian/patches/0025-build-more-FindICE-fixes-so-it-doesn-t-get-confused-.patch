From e6da0697c947b6c2e8def3ef1f75706f11ae9aa3 Mon Sep 17 00:00:00 2001
From: Tom Rondeau <tom@trondeau.com>
Date: Wed, 24 Jul 2013 12:53:15 -0400
Subject: [PATCH 25/31] build: more FindICE fixes so it doesn't get confused
 with multiple installs of ICE.

---
 cmake/Modules/FindICE-3.5.cmake |   60 +++++++++++++++++----------------------
 cmake/Modules/FindICE.cmake     |   60 ++++++++++++++++-----------------------
 2 files changed, 51 insertions(+), 69 deletions(-)

diff --git a/cmake/Modules/FindICE-3.5.cmake b/cmake/Modules/FindICE-3.5.cmake
index bcdaa4c..f56a274 100644
--- a/cmake/Modules/FindICE-3.5.cmake
+++ b/cmake/Modules/FindICE-3.5.cmake
@@ -11,7 +11,7 @@ if(NOT ICE_FOUND)
   FIND_PATH(
     ICE_CONFIG_INCLUDE_DIR 
     NAMES IceUtil/Config.h
-    HINTS ${CMAKE_INSTALL_PREFIX}/${HEADER_DIR} ${ICE_MANUAL_INSTALL_PATH}/include/
+    HINTS ${ICE_MANUAL_INSTALL_PATH}/include/ ${CMAKE_INSTALL_PREFIX}/${HEADER_DIR}
     )
   if(ICE_CONFIG_INCLUDE_DIR)
     file(STRINGS "${ICE_CONFIG_INCLUDE_DIR}/IceUtil/Config.h"
@@ -30,71 +30,63 @@ endif(NOT ICE_FOUND)
 # Recheck if we found the right version of ICE and proceed if true.
 if(ICE_FOUND)
 
+# Prepare the path hint for the libraries based on the include
+# directory found.
+string(REGEX REPLACE "/include" "" ICE_PATH ${ICE_CONFIG_INCLUDE_DIR})
+
 FIND_PATH(
-    ICE_INCLUDE_DIR 
-    NAMES IceUtil/IceUtil.h Ice/Ice.h IceStorm/IceStorm.h icestorm_publisher_template.h 
-    HINTS ${CMAKE_INSTALL_PREFIX}/${HEADER_DIR} ${ICE_MANUAL_INSTALL_PATH}/include/
+  ICE_INCLUDE_DIR 
+  NAMES IceUtil/IceUtil.h Ice/Ice.h
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/include
 )
 
 set(ICE_LIBRARY )
 
 FIND_LIBRARY(
-    ICE_ICESTORM IceStorm 
-    PATHS ENV LD_LIBRARY_PATH 
-    HINTS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-          ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
+  ICE_ICESTORM IceStorm 
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 
 FIND_LIBRARY(
   ICE_ICESTORM IceStorm
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_ICE Ice
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_ICEGRID IceGrid
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_ICEUTIL IceUtil
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_GLACIER2 Glacier2
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 
 if(APPLE)
   FIND_LIBRARY(
     ICE_ZEROCICE ZeroCIce
-    PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-    PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-          ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-    ENV LD_LIBRARY_PATH
+    NO_DEFAULT_PATH
+    HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
     )
 endif(APPLE)
 
 FIND_LIBRARY(
   ICE_PTHREAD NAMES pthread pthread-2.13
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS} /lib/i386-linux-gnu /lib/x86_64-linux-gnu /usr/lib /lib /lib64
+  HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
+  HINTS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS} /lib/i386-linux-gnu /lib/x86_64-linux-gnu /usr/lib /lib /lib64
   ENV LD_LIBRARY_PATH
 )
 
diff --git a/cmake/Modules/FindICE.cmake b/cmake/Modules/FindICE.cmake
index 86a812d..7ce9c2b 100644
--- a/cmake/Modules/FindICE.cmake
+++ b/cmake/Modules/FindICE.cmake
@@ -31,72 +31,63 @@ endif(NOT ICE_FOUND)
 # Recheck if we found the right version of ICE and proceed if true.
 if(ICE_FOUND)
 
+# Prepare the path hint for the libraries based on the include
+# directory found.
+string(REGEX REPLACE "/include" "" ICE_PATH ${ICE_CONFIG_INCLUDE_DIR})
+
 FIND_PATH(
-    ICE_INCLUDE_DIR 
-    NAMES IceUtil/IceUtil.h Ice/Ice.h IceStorm/IceStorm.h icestorm_publisher_template.h 
-    HINTS ${CMAKE_INSTALL_PREFIX}/${HEADER_DIR} ${ICE_MANUAL_INSTALL_PATH}/include/
+  ICE_INCLUDE_DIR 
+  NAMES IceUtil/IceUtil.h Ice/Ice.h
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/include
 )
 
 set(ICE_LIBRARY )
 
 FIND_LIBRARY(
-    ICE_ICESTORM IceStorm 
-    PATHS ENV LD_LIBRARY_PATH 
-    HINTS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-          ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
+  ICE_ICESTORM IceStorm 
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 
 FIND_LIBRARY(
   ICE_ICESTORM IceStorm
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_ICE Ice
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_ICEGRID IceGrid
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_ICEUTIL IceUtil
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 FIND_LIBRARY(
   ICE_GLACIER2 Glacier2
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-        ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-  ENV LD_LIBRARY_PATH
+  NO_DEFAULT_PATH
+  HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
 )
 
 if(APPLE)
   FIND_LIBRARY(
     ICE_ZEROCICE ZeroCIce
-    PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-    PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS}
-          ${ICE_MANUAL_INSTALL_PATH}/lib64/ ${ICE_MANUAL_INSTALL_PATH}/lib/
-    ENV LD_LIBRARY_PATH
+    NO_DEFAULT_PATH
+    HINTS ${ICE_PATH}/lib ${ICE_PATH}/lib64
     )
 endif(APPLE)
 
 FIND_LIBRARY(
   ICE_PTHREAD NAMES pthread pthread-2.13
-  PATHS HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
-  PATHS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS} /lib/i386-linux-gnu
-        /lib/x86_64-linux-gnu /usr/lib /lib /lib64
+  HINTS ${CMAKE_INSTALL_PREFIX}/lib64/ ${CMAKE_INSTALL_PREFIX}/lib/
+  HINTS ${PC_ICE_LIBDIR} ${PC_ICE_LIBRARY_DIRS} /lib/i386-linux-gnu /lib/x86_64-linux-gnu /usr/lib /lib /lib64
   ENV LD_LIBRARY_PATH
 )
 
@@ -104,7 +95,6 @@ set(ICE_FOUND FALSE)
 
 if(ICE_ICE OR ICE_ZEROCICE)
   if(ICE_ICEUTIL)
-
     list(APPEND ICE_LIBRARY
       ${ICE_ICE}
       ${ICE_ZEROCICE}
-- 
1.7.10.4

